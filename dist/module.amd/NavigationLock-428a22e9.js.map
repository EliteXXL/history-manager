{"version":3,"file":"NavigationLock-428a22e9.js","sources":["../../src/NavigationLock.ts"],"sourcesContent":["/**\r\n * @author Giuliano Collacchioni @2020\r\n */\r\n\r\nimport * as OptionsManager from \"./OptionsManager\";\r\nimport * as HistoryManager from \"./HistoryManager\";\r\n\r\nexport type Lock = {\r\n    readonly id: number,\r\n    listen(listener: (event: Event) => void): void;\r\n    unlisten(listener: (event: Event) => void): void;\r\n    unlock(): void;\r\n};\r\n\r\ntype Wrapper = {\r\n    lock: Lock;\r\n    fire(): boolean;\r\n    release(): void;\r\n    beginRelease(start_fn: () => void): void;\r\n};\r\n\r\nlet locks: Wrapper[] = [];\r\n\r\nlet catchPopState: null | (() => void) = null;\r\nwindow.addEventListener(\"popstate\", event => {\r\n    if (catchPopState == null) {\r\n        return handlePopState();\r\n    }\r\n    event.stopImmediatePropagation();\r\n    catchPopState();\r\n}, true);\r\n\r\nfunction onCatchPopState(onCatchPopState: () => void, once: boolean = false): void {\r\n    if (once) {\r\n        let tmpOnCatchPopState: () => void = onCatchPopState;\r\n        onCatchPopState = () => {\r\n            catchPopState = null;\r\n            tmpOnCatchPopState();\r\n        };\r\n    }\r\n    catchPopState = onCatchPopState;\r\n}\r\n\r\nexport function lock(): Promise<Lock> {\r\n    let delegate: EventTarget = new EventTarget();\r\n    let id: number = Date.now();\r\n    let historyLock: HistoryManager.ILock;\r\n    let promiseResolve: (lock: Lock) => void;\r\n    let promise: Promise<Lock> = new Promise<Lock>(resolve => {\r\n        promiseResolve = resolve;\r\n    });\r\n    HistoryManager.onWorkFinished(() => {\r\n        historyLock = HistoryManager.acquire();\r\n        let lock: Wrapper = {\r\n            lock: {\r\n                get id(): number {\r\n                    return id;\r\n                },\r\n                listen(listener: (event: Event) => void): void {\r\n                    delegate.addEventListener(\"navigation\", listener);\r\n                },\r\n                unlisten(listener: (event: Event) => void): void {\r\n                    delegate.removeEventListener(\"navigation\", listener);\r\n                },\r\n                unlock(): void {\r\n                    if (!locks.length || historyLock.finishing) {\r\n                        return;\r\n                    }\r\n                    promise.then(() => {\r\n                        if (locks[locks.length - 1].lock.id === id) {\r\n                            unlock();\r\n                        } else {\r\n                            locks.some((lock, index) => {\r\n                                if (lock.lock.id === id) {\r\n                                    locks.splice(index, 1)[0].release();\r\n                                }\r\n                                return false;\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n            },\r\n            fire(): boolean {\r\n                let e: Event = new Event(\"navigation\", { cancelable: true });\r\n                delegate.dispatchEvent(e);\r\n                return e.defaultPrevented;\r\n            },\r\n            release(): void {\r\n                historyLock.finish();\r\n            },\r\n            beginRelease(start_fn: () => void): void {\r\n                historyLock.beginFinish();\r\n                promise.then(() => {\r\n                    start_fn();\r\n                });\r\n            }\r\n        };\r\n        historyLock.askFinish = () => {\r\n            if (!lock.fire()) {\r\n                return false;\r\n            }\r\n            lock.lock.unlock();\r\n            return true;\r\n        };\r\n        locks.push(lock);\r\n\r\n        OptionsManager.goWith(\r\n            OptionsManager.clearHref(),\r\n            { ...OptionsManager.get(), locked: lock.lock.id }\r\n        ).then(() => {\r\n            promiseResolve(lock.lock);\r\n        });\r\n    });\r\n    return promise;\r\n}\r\n\r\nexport function unlock(force: boolean = true): boolean {\r\n    let wrapper: Wrapper = locks.splice(locks.length - 1, 1)[0];\r\n    if (wrapper == null) {\r\n        return true;\r\n    }\r\n    if (!force && !wrapper.fire()) {\r\n        return false;\r\n    }\r\n    wrapper.beginRelease(() => {\r\n        onCatchPopState(() => {\r\n            wrapper.release();\r\n        }, true);\r\n        window.history.go(-1);\r\n    });\r\n    return true;\r\n}\r\n\r\nexport function locked(): boolean {\r\n    return locks.length > 0;\r\n}\r\n\r\nlet shouldUnlock: boolean = false;\r\nfunction handlePopState(): void {\r\n    if (locks.length === 0) {\r\n        return;\r\n    }\r\n    let lockId: number = parseInt(OptionsManager.get().locked, 10);\r\n    if (isNaN(lockId)) {\r\n        shouldUnlock = true;\r\n        window.history.go(1);\r\n    } else {\r\n        let lock: Wrapper = locks[locks.length - 1];\r\n        if (lockId === lock.lock.id) {\r\n            if (shouldUnlock && lock.fire()) {\r\n                unlock();\r\n            }\r\n            shouldUnlock = false;\r\n            return;\r\n        } else if (lockId > lock.lock.id) {\r\n            window.history.go(-1);\r\n        } else {\r\n            shouldUnlock = true;\r\n            window.history.go(1);\r\n        }\r\n    }\r\n}"],"names":["HistoryManager.onWorkFinished","HistoryManager.acquire","OptionsManager.goWith","OptionsManager.clearHref","OptionsManager.get"],"mappings":"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"}