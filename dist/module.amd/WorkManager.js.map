{"version":3,"file":"WorkManager.js","sources":["../../src/WorkManager.ts"],"sourcesContent":["interface ILock {\r\n    release(): void;\r\n    beginRelease(start_fn: () => void): void;\r\n    readonly releasing: boolean;\r\n    readonly released: boolean;\r\n    onrelease<T>(callback: (this: T) => void, context?: T): void;\r\n}\r\n\r\nlet locks: ILock[] = [];\r\nexport function lock(locking_fn: (this: ILock, lock: ILock) => boolean | void): Promise<ILock> {\r\n    let released: boolean = false;\r\n    let releasing: boolean = false;\r\n    let onrelease: [() => void, any][] = [];\r\n    let promise: Promise<ILock>;\r\n    let lock: ILock = {\r\n        get released(): boolean {\r\n            return released;\r\n        },\r\n        get releasing(): boolean {\r\n            return releasing;\r\n        },\r\n        release(): void {\r\n            if (released) {\r\n                return;\r\n            }\r\n            released = true;\r\n            releasing = false;\r\n\r\n            let i: number = locks.length - 1;\r\n            for (; i >= 0; i--) {\r\n                if (locks[i] === lock) {\r\n                    locks.splice(i, 1);\r\n                    break;\r\n                }\r\n            }\r\n            if (i >= 0) {\r\n                onrelease.forEach(([callback, context]) => {\r\n                    callback.call(context || null);\r\n                });\r\n            }\r\n        },\r\n        beginRelease(start_fn: () => void): void {\r\n            releasing = true;\r\n            start_fn();\r\n        },\r\n        onrelease<T>(callback: (this: T) => void, context: T = null as any): void {\r\n            onrelease.push([callback, context || null]);\r\n        }\r\n    };\r\n    return promise = new Promise<ILock>(resolve => {\r\n        ondone(() => {\r\n            let result: boolean | void = locking_fn.call(lock, lock);\r\n            locks.push(lock);\r\n            if (result !== false && result !== void 0) {\r\n                lock.release();\r\n            }\r\n            resolve(lock);\r\n        });\r\n    });\r\n}\r\n\r\nexport function locked(): boolean {\r\n    return locks.length > 0 && locks.every(lock => !lock.releasing && !lock.released);\r\n}\r\n\r\nlet currentWork: number = -1;\r\nlet working: number = 0;\r\nlet ondoneCallbacks: [() => void, any][] = [];\r\nfunction completeWork(): void {\r\n    if (currentWork === -1) {\r\n        return;\r\n    }\r\n    if (--working === 0) {\r\n        currentWork = -1;\r\n        while (ondoneCallbacks.length && currentWork === -1) {\r\n            let [callback, context] = ondoneCallbacks.shift();\r\n            callback.call(context || null);\r\n        }\r\n    }\r\n}\r\n\r\nfunction ondoneWork<T>(fn: (this: T) => void, context: T, workId: number): void {\r\n    if (currentWork !== -1 && currentWork !== workId) {\r\n        ondoneCallbacks.push([fn, context || null]);\r\n        return;\r\n    }\r\n    fn.call(context || null as any);\r\n}\r\n\r\nexport function startWork(start_fn: (complete: () => void, id: number) => void, id: number = Date.now()): number {\r\n    if (locked()) {\r\n        console.error(\"navigation is locked\");\r\n        return -1;\r\n    }\r\n    let completed: boolean = false;\r\n    ondoneWork(() => {\r\n        currentWork = id;\r\n        working++;\r\n        start_fn(() => {\r\n            if (completed) {\r\n                return;\r\n            }\r\n            completed = true;\r\n            completeWork();\r\n        }, id);\r\n    }, null, id);\r\n    return id;\r\n}\r\n\r\nexport function ondone<T>(fn: (this: T) => void, context?: T): void {\r\n    if (working) {\r\n        ondoneCallbacks.push([fn, context || null]);\r\n        return;\r\n    }\r\n    fn.call(context || null as any);\r\n}"],"names":["__read"],"mappings":"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"}