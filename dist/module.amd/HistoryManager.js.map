{"version":3,"file":"HistoryManager.js","sources":["../../src/HistoryManager.ts"],"sourcesContent":["/**\r\n * @author Giuliano Collacchioni @2020\r\n */\r\n\r\nimport * as OptionsManager from \"./OptionsManager\";\r\n\r\nimport * as URLManager from \"./URLManager\";\r\nimport { ContextManager } from \"./ContextManager\";\r\n\r\nlet started: boolean = false;\r\n\r\nexport interface IWork {\r\n    finish(): void;\r\n    beginFinish(): void;\r\n    askFinish(): boolean;\r\n    readonly finishing: boolean;\r\n    readonly finished: boolean;\r\n    readonly locking: boolean;\r\n}\r\n\r\nexport interface ILock extends IWork {\r\n    readonly locking: true;\r\n}\r\n\r\nlet works: IWork[] = [];\r\n\r\nlet onworkfinished: [ () => void, any ][] = [];\r\nexport function onWorkFinished<T>(callback: (this: T) => void, context?: T): void {\r\n    if (works.length === 0) {\r\n        callback.call(context || null as any);\r\n        return;\r\n    }\r\n    onworkfinished.push([callback, context || null]);\r\n}\r\n\r\nfunction createWork(locking?: false): IWork;\r\nfunction createWork(locking: true): ILock;\r\nfunction createWork(locking: boolean = false): IWork | ILock {\r\n    let finished: boolean = false;\r\n    let finishing: boolean = false;\r\n    let work: IWork = {\r\n        get locking(): boolean {\r\n            return locking;\r\n        },\r\n        get finished(): boolean {\r\n            return finished;\r\n        },\r\n        get finishing(): boolean {\r\n            return finishing;\r\n        },\r\n        finish(): void {\r\n            if (finished) {\r\n                return;\r\n            }\r\n            finished = true;\r\n            finishing = false;\r\n\r\n            let i: number = works.length - 1;\r\n            for (; i >= 0; i--) {\r\n                if (works[i] === work) {\r\n                    works.splice(i, 1);\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (i >= 0 && works.length === 0) {\r\n                while (onworkfinished.length > 0 && works.length === 0) {\r\n                    let [callback, context] = onworkfinished.shift();\r\n                    callback.call(context || window);\r\n                }\r\n            }\r\n        },\r\n        beginFinish(): void {\r\n            finishing = true;\r\n        },\r\n        askFinish(): boolean {\r\n            return false;\r\n        }\r\n    };\r\n    works.push(work);\r\n    return work;\r\n}\r\n\r\nexport function acquire(): ILock {\r\n    let lock: ILock = createWork(true);\r\n    return lock;\r\n}\r\nfunction isLocked(): boolean {\r\n    return works.some(w => w.locking);\r\n}\r\nlet catchPopState: (() => void) | null = null;\r\nwindow.addEventListener(\"popstate\", event => {\r\n    if (!started || isLocked()) {\r\n        return;\r\n    }\r\n    if (catchPopState == null) {\r\n        handlePopState();\r\n        return;\r\n    }\r\n    event.stopImmediatePropagation();\r\n    catchPopState();\r\n}, true);\r\n\r\nfunction onCatchPopState(onCatchPopState: () => void, once: boolean = false): void {\r\n    if (once) {\r\n        let tmpOnCatchPopState: () => void = onCatchPopState;\r\n        onCatchPopState = () => {\r\n            catchPopState = null;\r\n            tmpOnCatchPopState();\r\n        };\r\n    }\r\n    catchPopState = onCatchPopState;\r\n}\r\n\r\nfunction goTo(href: string, replace: boolean = false): void {\r\n    href = URLManager.construct(href);\r\n    if (window.location.href === href) {\r\n        window.dispatchEvent(new Event(\"popstate\"));\r\n        return;\r\n    }\r\n    if (replace) {\r\n        window.location.replace(href);\r\n    } else {\r\n        window.location.assign(href);\r\n    }\r\n}\r\n\r\nexport function addFront(frontHref: string = \"next\"): Promise<void> {\r\n    let href: string = URLManager.get();\r\n    let work: IWork = createWork();\r\n    return new Promise(resolve => {\r\n        OptionsManager.goWith(URLManager.construct(frontHref), { back: undefined, front: null })\r\n        .then(() => new Promise<void>(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            window.history.go(-1);\r\n        }))\r\n        .then(() => new Promise(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            goTo(href, true);\r\n        }))\r\n        .then(() => {\r\n            work.finish();\r\n            resolve();\r\n        });\r\n    });\r\n}\r\n\r\nexport function addBack(backHref: string = \"\"): Promise<void> {\r\n    let href: string = URLManager.get();\r\n    let work: IWork = createWork();\r\n    return new Promise(resolve => {\r\n        (new Promise(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            window.history.go(-1);\r\n        }))\r\n        .then(() => new Promise(resolve => {\r\n            if (backHref) {\r\n                onCatchPopState(resolve, true);\r\n                goTo(backHref, true);\r\n            } else {\r\n                resolve();\r\n            }\r\n        }))\r\n        .then(() => OptionsManager.set({ back: null, front: undefined }))\r\n        .then(() => new Promise(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            goTo(href);\r\n        }))\r\n        .then(() => {\r\n            work.finish();\r\n            resolve();\r\n        });\r\n    });\r\n}\r\n\r\nlet hasBack: boolean = false;\r\n\r\nlet contextManager: ContextManager = new ContextManager();\r\nexport function index(): number {\r\n    return contextManager.index();\r\n}\r\n\r\nexport function getHREFAt(index: number): string | null {\r\n    return contextManager.get(index);\r\n}\r\n\r\nexport function setContext(context: {\r\n    name: string,\r\n    paths: { path: string, fallback?: boolean }[],\r\n    default?: string | null\r\n}): void {\r\n    return contextManager.setContext(context);\r\n}\r\n\r\nexport function addContextPath(context: string, href: string, isFallback: boolean = false): RegExp {\r\n    return contextManager.addContextPath(context, href, isFallback);\r\n}\r\nexport function setContextDefaultHref(context: string, href: string): void {\r\n    return contextManager.setContextDefaultHref(context, href);\r\n}\r\n\r\nexport function getContext(href: string | null = null): string | null {\r\n    if (href == null) {\r\n        return contextManager.currentContext();\r\n    }\r\n    return contextManager.contextOf(href);\r\n}\r\n\r\nexport function getHREFs(): string[] {\r\n    return contextManager.hrefs();\r\n}\r\n\r\nfunction tryUnlock(): number {\r\n    let locksAsked: number = 0;\r\n    for (let i: number = works.length - 1; i >= 0; i--) {\r\n        let work: IWork = works[i];\r\n        if (work.locking && !work.finishing) {\r\n            if (!work.askFinish()) {\r\n                return -1;\r\n            }\r\n            locksAsked++;\r\n        }\r\n    }\r\n    return locksAsked;\r\n}\r\n\r\nlet workToRelease: IWork | null = null;\r\n\r\nexport function restore(context: string): Promise<void> {\r\n    let locksFinished: number = tryUnlock();\r\n    if (locksFinished === -1) {\r\n        return new Promise((_, reject) => { reject(); });\r\n    }\r\n    let promiseResolve: () => void;\r\n    let promise: Promise<void> = new Promise(resolve => { promiseResolve = resolve;});\r\n    onWorkFinished(() => {\r\n        let previousIndex: number = contextManager.index();\r\n        if (contextManager.restore(context)) {\r\n            let replace: boolean = previousIndex >= contextManager.index();\r\n            workToRelease = createWork();\r\n            onWorkFinished(promiseResolve);\r\n            let href: string = contextManager.get()!;\r\n            let hadBack: boolean = hasBack;\r\n            (new Promise<void>(resolve => {\r\n                if (!replace && !hasBack) {\r\n                    onCatchPopState(resolve, true);\r\n                    goTo(href);\r\n                } else {\r\n                    resolve();\r\n                }\r\n            }))\r\n            .then(() => new Promise<void>(resolve => {\r\n                let index: number = contextManager.index() - 1;\r\n                if (replace && !hasBack) {\r\n                    resolve();\r\n                } else {\r\n                    addBack(contextManager.get(index)!)\r\n                    .then(() => {\r\n                        hasBack = true;\r\n                        resolve();\r\n                    });\r\n                }\r\n            }))\r\n            .then(() => new Promise(resolve => {\r\n                if (hadBack || replace) {\r\n                    onCatchPopState(resolve, true);\r\n                    goTo(href, true);\r\n                } else {\r\n                    resolve();\r\n                }\r\n            }))\r\n            .then(onlanded);\r\n        } else {\r\n            promiseResolve();\r\n        }\r\n    });\r\n    return promise;\r\n}\r\n\r\nexport function assign(href: string): Promise<void> {\r\n    let locksFinished: number = tryUnlock();\r\n    if (locksFinished === -1) {\r\n        return new Promise((_, reject) => { reject(); });\r\n    }\r\n    let promiseResolve: () => void;\r\n    let promise: Promise<void> = new Promise(resolve => { promiseResolve = resolve;});\r\n    onWorkFinished(() => {\r\n        workToRelease = createWork();\r\n        onWorkFinished(promiseResolve);\r\n        goTo(href);\r\n    });\r\n    return promise;\r\n}\r\n\r\nlet replacing: boolean = false;\r\nexport function replace(href: string): Promise<void> {\r\n    let locksFinished: number = tryUnlock();\r\n    if (locksFinished === -1) {\r\n        return new Promise((_, reject) => { reject(); });\r\n    }\r\n    let promiseResolve: () => void;\r\n    let promise: Promise<void> = new Promise(resolve => { promiseResolve = resolve; });\r\n    onWorkFinished(() => {\r\n        workToRelease = createWork();\r\n        onWorkFinished(promiseResolve);\r\n        goTo(href, replacing = true);\r\n    });\r\n    return promise;\r\n}\r\n\r\nexport function go(direction: number): Promise<void> {\r\n    let locksFinished: number = tryUnlock();\r\n    if (locksFinished === -1) {\r\n        return new Promise((resolve, reject) => {\r\n            reject();\r\n        });\r\n    }\r\n    if (direction === 0) {\r\n        throw new Error(\"direction must be different than 0\");\r\n    }\r\n    direction = parseInt(direction as any, 10) + locksFinished;\r\n    if (isNaN(direction)) {\r\n        throw new Error(\"direction must be a number\");\r\n    }\r\n    if (direction === 0) {\r\n        return Promise.resolve();\r\n    }\r\n    let promiseResolve: () => void;\r\n    let promise: Promise<void> = new Promise((resolve, reject) => { promiseResolve = resolve; });\r\n    onWorkFinished(() => {\r\n        let index: number = contextManager.index() + direction;\r\n        if (index < 0 || index >= contextManager.length()) {\r\n            return onlanded();\r\n        }\r\n        workToRelease = createWork();\r\n        onWorkFinished(promiseResolve);\r\n        if (direction > 0) {\r\n            contextManager.index(index - 1);\r\n            window.history.go(1);\r\n        } else {\r\n            contextManager.index(index + 1);\r\n            window.history.go(-1);\r\n        }\r\n    });\r\n    return promise;\r\n}\r\n\r\nexport function start(fallbackContext: string | null = contextManager.getContextNames()[0]): void {\r\n    let href: string = URLManager.get();\r\n    let context: string | null = contextManager.contextOf(href, false);\r\n    if (context == null) {\r\n        if (!fallbackContext) {\r\n            throw new Error(\"must define a fallback context\");\r\n        }\r\n        let defaultHREF: string | null = contextManager.getDefaultOf(fallbackContext);\r\n        if (defaultHREF == null) {\r\n            throw new Error(\"must define a default href for the fallback context\");\r\n        }\r\n        started = true;\r\n        href = defaultHREF;\r\n        workToRelease = createWork();\r\n        onCatchPopState(onlanded, true);\r\n        goTo(defaultHREF, true);\r\n    }\r\n    contextManager.insert(href);\r\n    if (context != null) {\r\n        started = true;\r\n        onlanded();\r\n    }\r\n}\r\n\r\nfunction onlanded(): void {\r\n    window.dispatchEvent(new Event(\"historylanded\"));\r\n    if (workToRelease != null) {\r\n        let work: IWork = workToRelease;\r\n        workToRelease = null;\r\n        work.finish();\r\n    }\r\n}\r\n\r\nfunction handlePopState(): void {\r\n    let options: OptionsManager.Options = OptionsManager.get();\r\n    if (options.locked) {\r\n        onCatchPopState(() => {\r\n            if (OptionsManager.get().locked) {\r\n                handlePopState();\r\n            }\r\n        }, true);\r\n        window.history.go(-1);\r\n        return;\r\n    }\r\n    if (options.front !== undefined) {\r\n        let frontEvent: Event = new Event(\"historyforward\", { cancelable: true });\r\n        window.dispatchEvent(frontEvent);\r\n        if (frontEvent.defaultPrevented) {\r\n            onCatchPopState(() => { return; }, true);\r\n            window.history.go(-1);\r\n            return;\r\n        }\r\n        // should go forward in history\r\n        let backHref: string = contextManager.get()!;\r\n        let href: string = contextManager.goForward();\r\n        (new Promise<void>(resolve => {\r\n            if (hasBack) {\r\n                onCatchPopState(resolve, true);\r\n                window.history.go(-1);\r\n            } else {\r\n                resolve();\r\n            }\r\n        }))\r\n        .then(() => new Promise<void>(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            goTo(href, true);\r\n        }))\r\n        .then(addBack.bind(null, backHref))\r\n        .then(() => new Promise<void>(resolve => {\r\n            if (contextManager.index() < contextManager.length() - 1) {\r\n                onCatchPopState(resolve, true);\r\n                addFront(contextManager.get(contextManager.index() + 1)!).then(resolve);\r\n            } else {\r\n                resolve();\r\n            }\r\n        }))\r\n        .then(() => {\r\n            hasBack = true;\r\n            onlanded();\r\n        });\r\n    } else if (options.back !== undefined) {\r\n        let backEvent: Event = new Event(\"historybackward\", { cancelable: true });\r\n        window.dispatchEvent(backEvent);\r\n        if (backEvent.defaultPrevented) {\r\n            onCatchPopState(() => { return; }, true);\r\n            window.history.go(+1);\r\n            return;\r\n        }\r\n        // should go backward in history\r\n        let frontHref: string = contextManager.get()!;\r\n        let href: string = contextManager.goBackward();\r\n        (new Promise<void>(resolve => {\r\n            if (contextManager.index() > 0) {\r\n                onCatchPopState(resolve, true);\r\n                window.history.go(1);\r\n            } else {\r\n                resolve();\r\n            }\r\n        })).then(() => new Promise<void>(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            goTo(href, true);\r\n        }))\r\n        .then(addFront.bind(null, frontHref))\r\n        .then(() => {\r\n            hasBack = contextManager.index() > 0;\r\n            onlanded();\r\n        });\r\n    } else {\r\n        // should add new page to history\r\n        let href: string = URLManager.get();\r\n        let backHref: string = contextManager.get()!;\r\n        if (href === backHref) {\r\n            return onlanded();\r\n        }\r\n        let replaced: boolean = replacing;\r\n        replacing = false;\r\n        let willHaveBack: boolean = hasBack || !replaced;\r\n        contextManager.insert(href, replaced);\r\n        (new Promise<void>(resolve => {\r\n            if (hasBack && !replaced) {\r\n                onCatchPopState(resolve, true);\r\n                window.history.go(-1);\r\n            } else {\r\n                resolve();\r\n            }\r\n        }))\r\n        .then(() => {\r\n            if (replaced) {\r\n                return Promise.resolve();\r\n            }\r\n            return addBack(backHref);\r\n        })\r\n        .then(() => new Promise(resolve => {\r\n            onCatchPopState(resolve, true);\r\n            goTo(href, true);\r\n        }))\r\n        .then(() => {\r\n            hasBack = willHaveBack;\r\n            onlanded();\r\n        });\r\n    }\r\n}"],"names":["__read","URLManager.construct","URLManager.get","OptionsManager.goWith","OptionsManager.set","ContextManager","OptionsManager.get"],"mappings":"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"}